<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åŠ±ã¾ã—ç­‹ãƒˆãƒ¬ã‚¿ã‚¤ãƒãƒ¼</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">
<style>
/* ========= Base ========= */
html { -webkit-text-size-adjust: 100%; }
body{
  font-family:"Hiragino Sans","Yu Gothic",system-ui,-apple-system,sans-serif;
  margin:0; padding:12px; min-height:100vh;
  background:linear-gradient(135deg,#ffeef8 0%,#f0f8ff 50%,#fff0f8 100%);
  color:#5a4b7a; box-sizing:border-box;
}
.container{
  max-width:100%; width:100%; margin:0 auto; padding:16px;
  background:rgba(255,255,255,.9); border-radius:20px;
  box-shadow:0 8px 32px rgba(0,0,0,.1); backdrop-filter:blur(10px);
  box-sizing:border-box;
}
@media (min-width:420px){ .container{max-width:400px; padding:24px; border-radius:24px;} body{padding:20px;} }

/* ========= Heading ========= */
h1{
  /* ã‚µã‚¤ã‚ºã¯å°‘ã—ä¸‹é™ã‚’å°ã•ã‚ã«ã—ã¦åã¾ã‚Šã‚„ã™ã */
  font-size:clamp(.9rem,4.5vw,1.5rem);
  margin-bottom:.75rem; text-align:center; font-weight:bold; line-height:1.25;

  /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ï¼ˆæ—¥æœ¬èªå‘ã‘ï¼‰ */
  white-space:normal;
  word-break:normal;             /* CJK ã§è‡ªç„¶ãªæ”¹è¡Œ */
  overflow-wrap:anywhere;        /* ã¯ã¿å‡ºã—å‰æã§ã‚‚æŠ˜ã‚Šè¿”ã™ */
  line-break:strict;             /* å’Œæ–‡ã®ç¦å‰‡ã«é…æ…® */
  text-wrap:balance;             /* Safari/æ–°Edge ã§è¦‹å‡ºã—ã‚’ãã‚Œã„ã« */

  /* ã‚¯ãƒªãƒƒãƒ—ã‚°ãƒ©ãƒ‡ï¼ˆéSafariï¼‰ */
  background:linear-gradient(45deg,#ff6b9d,#c44569);
  background:-webkit-linear-gradient(45deg,#ff6b9d,#c44569);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;

  /* ä»¥å‰ã® overflow:hidden ã¯è¦‹åˆ‡ã‚Œã®åŸå› ãªã®ã§å‰Šé™¤ */
}

/* Safari ã¯ã‚°ãƒ©ãƒ‡æ–‡å­—ã‚’ã‚„ã‚ã¦å®Ÿç·šè‰²ã«ï¼ˆæŠ˜ã‚Šè¿”ã—å®‰å®šï¼‰ */
@supports (-webkit-touch-callout: none){
  h1{-webkit-text-fill-color:#ff6b9d; background:none;}
}

/* ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ©ãƒƒãƒ‘ã¯ãƒ–ãƒ­ãƒƒã‚¯+å¹…100%ã«ã—ã¦æŠ˜ã‚Šè¿”ã›ã‚‹ã‚ˆã†ã« */
.title-text{display:block; width:100%;}

/* ãƒ¢ãƒã‚¤ãƒ«/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã®å‡ºã—åˆ†ã‘ */
.title-mobile{display:block;}
.title-desktop{display:none;}
@media (min-width:420px){
  .title-mobile{display:none;}
  .title-desktop{display:block;}
}
@media (max-width:320px){ h1{font-size:16px;} }

/* ========= Rows & Inputs ========= */
.row{margin:12px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:center;}
@media (min-width:420px){ .row{margin:16px 0; gap:12px;} }
input[type="number"]{
  width:clamp(4rem,20vw,5rem); padding:clamp(.6rem,3vw,1rem); font-size:clamp(.8rem,3.5vw,1rem);
  border:2px solid #ffc1e3; border-radius:clamp(.75rem,3vw,1rem);
  background:rgba(255,255,255,.8); text-align:center; color:#5a4b7a; font-weight:bold; box-sizing:border-box;
}
input:focus{outline:none; border-color:#ff6b9d; box-shadow:0 0 0 3px rgba(255,107,157,.2);}
label{font-weight:bold; color:#8b7aa8; font-size:clamp(.75rem,3vw,.9rem); white-space:nowrap;}

button{
  padding:clamp(.75rem,3vw,1rem) clamp(1.25rem,5vw,1.5rem);
  border:none; border-radius:clamp(1rem,4vw,1.25rem);
  background:linear-gradient(45deg,#ff6b9d,#ff8fab); color:#fff;
  font-size:clamp(.8rem,3.5vw,1rem); font-weight:bold; cursor:pointer; transition:.3s ease;
  box-shadow:0 4px 15px rgba(255,107,157,.3); white-space:nowrap;
}
button:hover{transform:translateY(-2px); box-shadow:0 6px 20px rgba(255,107,157,.4);}
button:active{transform:translateY(0);}
#stopBtn{background:linear-gradient(45deg,#a8a8a8,#c0c0c0); box-shadow:0 4px 15px rgba(168,168,168,.3);}

/* ========= Status / Message ========= */
#status{
  margin-top:clamp(1.25rem,5vw,1.5rem); font-size:clamp(1rem,4.5vw,1.3rem);
  text-align:center; font-weight:bold; color:#ff6b9d; text-shadow:0 2px 4px rgba(255,107,157,.3);
  line-height:1.5; padding:clamp(.75rem,3vw,1rem);
  background:rgba(255,193,227,.1); border-radius:clamp(.75rem,3vw,1rem); border:1px solid rgba(255,193,227,.3);
  /* ã“ã“ã‚‚æŠ˜ã‚Šè¿”ã—ã‚’æ˜ç¤º */
  white-space:normal; word-break:normal; overflow-wrap:anywhere; line-break:strict;
}
#msg{
  margin-top:20px; font-size:18px; min-height:2em; text-align:center;
  background:linear-gradient(135deg,#fff,#ffeef8); padding:20px; border-radius:20px; border:2px solid #ffc1e3;
  color:#8b7aa8; font-weight:bold; box-shadow:0 4px 15px rgba(255,193,227,.3); position:relative; overflow:hidden;
  white-space:normal; word-break:normal; overflow-wrap:anywhere; line-break:strict;
}
#msg::before{content:'ğŸ’–'; position:absolute; top:8px; right:12px; font-size:16px; opacity:.6;}

.hint{color:#a8a8a8; font-size:13px; text-align:center; margin-top:16px; padding:12px; background:rgba(255,255,255,.6); border-radius:12px;}

.working{animation:pulse 2s infinite;}
@keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.05);}100%{transform:scale(1);}}
.completed{animation:celebration .8s ease-out;}
@keyframes celebration{0%{transform:scale(1) rotate(0);}25%{transform:scale(1.1) rotate(-5deg);}75%{transform:scale(1.1) rotate(5deg);}100%{transform:scale(1) rotate(0);}}

.range{-webkit-appearance:none;width:140px;height:6px;border-radius:999px;background:#ffe0ef;outline:none;}
.range::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:#ff6b9d;cursor:pointer;border:2px solid #fff;box-shadow:0 0 0 2px rgba(255,107,157,.2);}
small{color:#8b7aa8;}
</style>
</head>
<body>
<div class="container">
  <h1>
    <span class="title-text title-mobile">ğŸ’ª Workout Timer ğŸŒ¸</span>
    <span class="title-text title-desktop">ğŸ’ª Cheer Workout Timer ğŸŒ¸</span>
  </h1>

  <div class="row">
    <label>ã‚»ãƒƒãƒˆæ•° <input id="sets" type="number" value="8" min="1" /></label>
    <label>ä½œæ¥­(ç§’) <input id="work" type="number" value="45" min="5" /></label>
    <label>ä¼‘æ†©(ç§’) <input id="rest" type="number" value="15" min="0" /></label>
  </div>

  <!-- èª­ã¿ä¸Šã’é€Ÿåº¦ -->
  <div class="row">
    <label>èª­ã¿ä¸Šã’é€Ÿåº¦
      <input id="rate" class="range" type="range" min="0.5" max="1.0" step="0.01">
    </label>
    <small id="rateVal"></small>
  </div>

  <div class="row">
    <button id="startBtn">ğŸŒŸ Start</button>
    <button id="stopBtn">â¸ï¸ Stop</button>
    <button id="installBtn" hidden>ğŸ“± Add to Home</button>
  </div>

  <div class="hint">ğŸ”Š éŸ³é‡ONã«ã—ã¦ã€ŒStartã€ã‚’æŠ¼ã™ã¨èª­ã¿ä¸Šã’ãŒå‹•ãã¾ã™ã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨å…¨ç”»é¢ã§ä½¿ãˆã¾ã™ã€‚</div>
  <div id="status">ğŸ’¤ Stopped</div>
  <div id="msg"></div>
</div>

<script>
/* === SW === */
if ('serviceWorker' in navigator) addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));

/* === Install === */
let deferredPrompt=null;
const installBtn=document.getElementById('installBtn');
addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.hidden=false;});
installBtn.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.hidden=true;});

/* === Wake Lock === */
let wakeLock=null;
async function requestWakeLock(){try{if('wakeLock'in navigator){wakeLock=await navigator.wakeLock.request('screen');}}catch(e){}}
function releaseWakeLock(){try{wakeLock?.release();wakeLock=null;}catch(e){}}
addEventListener('visibilitychange',()=>{if(document.visibilityState==='visible'&&wakeLock)requestWakeLock();});

/* === Rate UI persist === */
const rateEl=document.getElementById('rate');
const rateVal=document.getElementById('rateVal');
const savedRate=parseFloat(localStorage.getItem('cheer-rate')||'0.7');
rateEl.value=savedRate.toFixed(2); rateVal.textContent=savedRate.toFixed(2);
rateEl.addEventListener('input',()=>{const v=parseFloat(rateEl.value);rateVal.textContent=v.toFixed(2);localStorage.setItem('cheer-rate',v.toString());});

/* === Voices === */
let voices=[];
function refreshVoices(){voices=speechSynthesis.getVoices()||[];}
refreshVoices();
if(typeof speechSynthesis!=='undefined' && speechSynthesis.onvoiceschanged!==undefined){
  speechSynthesis.onvoiceschanged=refreshVoices;
}
function jpVoice(){
  const jp=voices.filter(v=>(v.lang||'').toLowerCase().startsWith('ja'));
  return jp.find(v=>/Kyoko/i.test(v.name))||jp.find(v=>/Google/.test(v.name))||jp.find(v=>/Microsoft/i.test(v.name))||jp[0]||null;
}

/* === Talk (slow & stable) === */
function speak(text,opts={}){
  return new Promise(resolve=>{
    try{
      const u=new SpeechSynthesisUtterance();
      u.lang="ja-JP";
      u.text=text.replace(/ã€/g,'ã€ã€€').replace(/ï¼/g,'ï¼ã€€').replace(/ã€‚/g,'ã€‚ã€€');
      const v=jpVoice(); if(v) u.voice=v;

      const ua=navigator.userAgent;
      const isChrome=/Chrome/.test(ua)&&/Google Inc/.test(navigator.vendor);
      const isSafari=/Safari/.test(ua)&&/Apple Computer/.test(navigator.vendor);
      const isFirefox=/Firefox/.test(ua);

      let mul=0.7; if(isChrome) mul=0.65; if(isSafari) mul=0.7; if(isFirefox) mul=0.6;
      const userMul=parseFloat(localStorage.getItem('cheer-rate')||'0.7');
      const baseRate=Math.max(0.5,Math.min(1.0,(opts.rate||1.0)*mul*userMul));
      const basePitch=Math.max(0.9,Math.min(1.1,opts.pitch||1.0));

      const rVar=(Math.random()-0.5)*0.04, pVar=(Math.random()-0.5)*0.04;
      const shortCheer=text.length<=15 && /[!ï¼]|(ãƒŠã‚¤ã‚¹|é ‘å¼µ|æœ€é«˜|ãƒ•ã‚¡ã‚¤ãƒˆ|ã™ã”ã„)/.test(text);

      if(shortCheer){ u.rate=Math.max(0.55,Math.min(0.9,baseRate+0.05+rVar)); u.pitch=Math.max(0.95,Math.min(1.2,basePitch+0.05+pVar)); }
      else if(opts.emotion==='calm'){ u.rate=Math.max(0.5,Math.min(0.85,baseRate-0.05+rVar)); u.pitch=Math.max(0.9,Math.min(1.05,basePitch-0.03+pVar)); }
      else if(opts.emotion==='encouragement'){ u.rate=Math.max(0.55,Math.min(0.95,baseRate+0.03+rVar)); u.pitch=Math.max(0.95,Math.min(1.15,basePitch+0.03+pVar)); }
      else { u.rate=Math.max(0.55,Math.min(0.9,baseRate+rVar)); u.pitch=Math.max(0.95,Math.min(1.1,basePitch+pVar)); }

      u.onend=()=>setTimeout(resolve,250);
      u.onerror=()=>resolve();
      speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){ resolve(); }
  });
}

/* === Phrases === */
const phrases={
  start:["ã„ã„èª¿å­ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ã¦ï¼","å‘¼å¸ã‚’å¿˜ã‚Œãšã«ã€ä¸å¯§ã«ï¼","èƒŒä¸­ã®è»¸ã¾ã£ã™ãã€ãƒŠã‚¤ã‚¹ï¼","é›†ä¸­ã€ãƒªã‚ºãƒ ã‚’ã‚­ãƒ¼ãƒ—ï¼"],
  middle:["ãã®èª¿å­ã€ç¶™ç¶šãŒå¤§åˆ‡ï¼","ãã‚‡ã†ã®åŠªåŠ›ã¯æ˜æ—¥ã®è‡ªä¿¡ï¼","ã„ã„ãƒšãƒ¼ã‚¹ã€ãã®ã¾ã¾ç¶šã‘ã¦ï¼","ä½“ã®å£°ã‚’èããªãŒã‚‰ã€ä¸å¯§ã«ï¼"],
  end:["ã‚ã¨ã¡ã‚‡ã£ã¨ã€ã“ã“ã‚’ä¹—ã‚Šè¶ŠãˆãŸã‚‰å¼·ããªã‚‹ï¼","ã“ã“ã‹ã‚‰ãŒæœ¬ç•ªã€ç²˜ã‚ã†ï¼","æœ€å¾Œã¾ã§æ°—ã‚’æŠœã‹ãšã«ï¼","æœ€å¾Œã®ã²ã¨è¸ã‚“å¼µã‚Šã€é ‘å¼µã£ã¦ï¼"]
};
function phrase(i,total){const p=i/total;const a=p<=.3?phrases.start:p<=.7?phrases.middle:phrases.end;return a[Math.floor(Math.random()*a.length)];}

/* === Flow === */
let running=false,currentSet=0,timerId=null;
function show(t){document.getElementById("msg").textContent=t;}
function setStatus(t){document.getElementById("status").textContent=t;}
function waitSec(s){return new Promise(res=>{timerId=setTimeout(res,s*1000);});}

async function run(){
  const total=parseInt(document.getElementById("sets").value,10);
  const work=parseInt(document.getElementById("work").value,10);
  const rest=parseInt(document.getElementById("rest").value,10);

  running=true; currentSet=0;
  setStatus("ğŸŒ¸ Getting Ready\nãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ã¦"); show("ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ã‚ˆã†");
  await speak("æº–å‚™é–‹å§‹ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ„è­˜ã—ã‚ˆã†ã€‚",{emotion:'calm'}); if(navigator.vibrate) navigator.vibrate([50]);

  await requestWakeLock(); await waitSec(1.5);

  while(running && currentSet<total){
    currentSet++;
    setStatus(`ğŸ’ª Set ${currentSet}/${total} WORKOUT (${work}sec)`); document.getElementById("status").className="working";
    const p=phrase(currentSet,total); show(p); await speak(p,{emotion:'encouragement'}); await waitSec(.8); if(navigator.vibrate) navigator.vibrate([100,50,100]);
    await waitSec(work); if(!running) break;

    if(currentSet<total && rest>0){
      setStatus(`ğŸ˜Œ Rest Time\n${rest} sec left`); document.getElementById("status").className="";
      const rp="å‘¼å¸ã‚’æ•´ãˆã¦ã€æ¬¡ã‚‚ä¸å¯§ã«ã€‚"; show(rp); await speak(rp,{emotion:'calm'}); if(navigator.vibrate) navigator.vibrate([100]); await waitSec(rest);
    }
  }

  if(running){
    setStatus("ğŸ‰ Complete! Great Job! ğŸ‰"); document.getElementById("status").className="completed";
    const ep="ã‚„ã‚Šåˆ‡ã£ãŸï¼ã™ã°ã‚‰ã—ã„é›†ä¸­åŠ›ï¼"; show(ep); await speak(ep,{emotion:'encouragement'}); if(navigator.vibrate) navigator.vibrate([200,80,200,80,200]);
  }
  running=false; releaseWakeLock();
}

/* === Buttons === */
document.getElementById("startBtn").addEventListener("click",()=>{if(!running) run();});
document.getElementById("stopBtn").addEventListener("click",()=>{
  running=false; clearTimeout(timerId); speechSynthesis.cancel();
  setStatus("ğŸ’¤ åœæ­¢ä¸­"); document.getElementById("status").className=""; show(""); releaseWakeLock();
});
</script>
</body>
</html>